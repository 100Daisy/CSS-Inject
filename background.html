<html>
<head>
    <script>

    // TODO: Shortcut keys 
    // TODO: Optionally remove all existing CSS?
    // TODO: Keep 'on' state after page refresh

    var state = 'off';

    function error(msg) {
        alert('ERROR: ' + msg);
    }

    function turnOn(tabId) {
        state = 'on';
        chrome.browserAction.setBadgeText({text: 'on', tabId: tabId});
    }

    function turnOff(tabId) {
        chrome.browserAction.setBadgeText({text: '', tabId: tabId});
        state = 'off';
    }

    function isUrlValid(url) {
        return (url && url.length > 3) ? true : false;
    }

    // EVENTS

    // User clicked the activate action button
    chrome.browserAction.onClicked.addListener(function(tab) {

        // error check
        if (!isUrlValid(localStorage['cssfile'])) {
            error('No CSS url specified. Please specify url in extesion options.');
            return;
        }

        // toggle state on click
        state = state === 'off' ? 'on' : 'off';

        // send a 'load/unload' msg to the embedded content script
        chrome.tabs.sendRequest(
            tab.id, 
            {
                state: state, 
                id: 'cssinject-injected-cssfile', 
                href: localStorage['cssfile'] + '?' + (new Date()).getTime()
            }, 
            function(resp) {
                if (!resp.ok) {
                    error('Could not load CSS file');
                }

                state === 'on' ? turnOn(tab.id) : turnOff(tab.id);
            }
        );

    });

    </script>
</head>
</html>
